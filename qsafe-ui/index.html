<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum-Safe Wallet</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const CONTRACT_ADDRESS = "0x76CE129C7C420f10c0Dcb4d418259a8Bd59E7F27";
        const CONTRACT_ABI = [
            "function registerKey(bytes32 publicKeyHash) external",
            "function sendWithPQVerification(address to, bytes calldata journal, bytes calldata seal) external payable",
            "function registeredKeys(address) external view returns (bytes32)"
        ];

        function App() {
          const [account, setAccount] = React.useState(null);
          const [signer, setSigner] = React.useState(null);
          const [network, setNetwork] = React.useState(null);
          const [isConnecting, setIsConnecting] = React.useState(false);
          const [isGeneratingKey, setIsGeneratingKey] = React.useState(false);
          const [isRegistering, setIsRegistering] = React.useState(false);
          const [isSigning, setIsSigning] = React.useState(false);
          const [isSending, setIsSending] = React.useState(false);
          const [keyGenerated, setKeyGenerated] = React.useState(false);
          const [keyRegistered, setKeyRegistered] = React.useState(false);
          const [messageSigned, setMessageSigned] = React.useState(false);
          const [txResult, setTxResult] = React.useState(null);
          const [recipient, setRecipient] = React.useState('');
          const [amount, setAmount] = React.useState('');
          const [error, setError] = React.useState(null);
          const [publicKeyHash, setPublicKeyHash] = React.useState('');
          const [signature, setSignature] = React.useState('');
          const [message, setMessage] = React.useState('Hello, post-quantum world!');

          const connectWallet = async () => {
            if (!window.ethereum) {
              alert("Please install MetaMask!");
              return;
            }
            
            setIsConnecting(true);
            setError(null);
            
            try {
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              await provider.send("eth_requestAccounts", []);
              const signer = provider.getSigner();
              const address = await signer.getAddress();
              
              const network = await provider.getNetwork();
              setNetwork(network);
              
              setAccount(address);
              setSigner(signer);
              
            } catch (error) {
              console.error("Error connecting to MetaMask:", error);
              setError("Failed to connect to MetaMask: " + error.message);
            } finally {
              setIsConnecting(false);
            }
          };

          // REAL Dilithium key generation via API
          const generateKey = async () => {
            setIsGeneratingKey(true);
            setError(null);
            
            try {
              const response = await fetch('http://localhost:3003/api/generate-keypair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
              
              const result = await response.json();
              
              if (result.success) {
                setPublicKeyHash(result.publicKeyHash);
                setKeyGenerated(true);
              } else {
                setError('REAL key generation failed: ' + result.error);
              }
            } catch (err) {
              setError('Failed to call REAL Dilithium binary: ' + err.message);
            } finally {
              setIsGeneratingKey(false);
            }
          };

          const registerKey = async () => {
            if (!publicKeyHash || !signer) {
              setError('Please generate a key and connect your wallet first');
              return;
            }

            setIsRegistering(true);
            setError(null);

            try {
              const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
              const formattedHash = '0x' + publicKeyHash;

              const tx = await contract.registerKey(formattedHash);
              const receipt = await tx.wait();
              
              setKeyRegistered(true);
              console.log("REAL key registered:", receipt.transactionHash);
              
            } catch (err) {
              console.error('Error registering key:', err);
              setError(err.message);
            } finally {
              setIsRegistering(false);
            }
          };

          // REAL Dilithium signing via API
          const signMessage = async () => {
            if (!keyRegistered) {
              setError('Please register your key first');
              return;
            }

            setIsSigning(true);
            setError(null);
            
            try {
              const response = await fetch('http://localhost:3003/api/sign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
              });
              
              const result = await response.json();
              
              if (result.success) {
                setSignature(result.signature);
                setMessageSigned(true);
              } else {
                setError('REAL signing failed: ' + result.error);
              }
            } catch (err) {
              setError('Failed to call REAL Dilithium signing: ' + err.message);
            } finally {
              setIsSigning(false);
            }
          };

          const handleRecipientChange = (e) => {
            setRecipient(e.target.value);
          };

          const handleAmountChange = (e) => {
            setAmount(e.target.value);
          };

          // REAL dual verification with REAL zkVM proof
          const sendTransaction = async () => {
            if (!recipient || !amount || !signer || !messageSigned) {
              setError('Please complete all steps first');
              return;
            }

            if (!ethers.utils.isAddress(recipient)) {
              setError('Invalid Ethereum address');
              return;
            }

            setIsSending(true);
            setError(null);

            try {
              // Generate REAL zkVM proof via API
              const verifyResponse = await fetch('http://localhost:3003/api/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
              });
              
              const verifyResult = await verifyResponse.json();
              
              if (!verifyResult.success) {
                throw new Error('REAL zkVM proof generation failed: ' + verifyResult.error);
              }

              const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
              const amountWei = ethers.utils.parseEther(amount);
              
              // Send with REAL zkVM proof from RISC Zero
              const tx = await contract.sendWithPQVerification(
                recipient, 
                '0x' + verifyResult.proof.journal, 
                '0x' + verifyResult.proof.seal, 
                { value: amountWei }
              );
              
              const receipt = await tx.wait();
              
              setTxResult({
                success: true,
                txHash: receipt.transactionHash,
                dualVerified: true
              });
              
              console.log("REAL dual-verified transaction:", receipt);
              
            } catch (err) {
              console.error('Error with REAL verification:', err);
              setError(err.message);
            } finally {
              setIsSending(false);
            }
          };

          React.useEffect(() => {
            const checkConnection = async () => {
              if (window.ethereum) {
                try {
                  const provider = new ethers.providers.Web3Provider(window.ethereum);
                  const accounts = await provider.listAccounts();
                  
                  if (accounts.length > 0) {
                    const signer = provider.getSigner();
                    const address = await signer.getAddress();
                    
                    const network = await provider.getNetwork();
                    setNetwork(network);
                    
                    setAccount(address);
                    setSigner(signer);
                  }
                } catch (error) {
                  console.error("Error checking wallet connection:", error);
                }
              }
            };
            
            checkConnection();
          }, []);

          return (
            <div className="app-container">
              <header>
                <h1>Quantum-Safe Wallet</h1>
                <p>üî• REAL Dilithium-5 + RISC Zero zkVM Implementation üî•</p>
                
                {!account ? (
                  <button 
                    onClick={connectWallet} 
                    disabled={isConnecting}
                    className="connect-button"
                  >
                    {isConnecting ? 'Connecting...' : 'Connect MetaMask'}
                  </button>
                ) : (
                  <div className="account-info">
                    <span>Connected: {account.substring(0, 6)}...{account.substring(account.length - 4)}</span>
                    {network && (
                      <span className="network-badge">Network: {network.name}</span>
                    )}
                  </div>
                )}
              </header>

              <div className="tab-content">
                <div className="wallet-container">
                  <div className="contract-info">
                    <p><strong>‚úÖ Contract:</strong> {CONTRACT_ADDRESS}</p>
                    <p><strong>Status:</strong> <span className="status-real">üî• REAL IMPLEMENTATION üî•</span></p>
                  </div>
                  
                  <div className="workflow-steps">
                    <div className="step">
                      <h3>Step 1: Generate REAL Dilithium-5 Key</h3>
                      <p>Calls actual Rust binary with REAL Dilithium implementation</p>
                      <button 
                        onClick={generateKey} 
                        disabled={isGeneratingKey || keyGenerated}
                        className="btn-primary"
                      >
                        {isGeneratingKey ? 'Generating REAL Key...' : 'üî• Generate REAL PQ Key'}
                      </button>
                      
                      {keyGenerated && (
                        <div className="success-message">
                          <p>‚úÖ REAL Dilithium-5 key generated via Rust binary!</p>
                          <p className="hash-display">Hash: {publicKeyHash.substring(0, 10)}...{publicKeyHash.substring(publicKeyHash.length - 10)}</p>
                        </div>
                      )}
                    </div>
                    
                    <div className="step">
                      <h3>Step 2: Register REAL Key On-Chain</h3>
                      <p>Register the actual generated key hash in smart contract</p>
                      <button 
                        onClick={registerKey} 
                        disabled={isRegistering || !keyGenerated || !signer || keyRegistered}
                        className="btn-primary"
                      >
                        {isRegistering ? 'Registering REAL Key...' : 'üî• Register REAL Key'}
                      </button>
                      
                      {keyRegistered && (
                        <div className="success-message">
                          <p>‚úÖ REAL key registered on-chain!</p>
                        </div>
                      )}
                    </div>
                    
                    <div className="step">
                      <h3>Step 3: Sign with REAL Dilithium-5</h3>
                      <p>Use actual Dilithium signing algorithm via Rust binary</p>
                      <div className="input-group">
                        <input 
                          type="text" 
                          value={message} 
                          onChange={(e) => setMessage(e.target.value)}
                          placeholder="Message to sign"
                        />
                      </div>
                      <button 
                        onClick={signMessage} 
                        disabled={isSigning || !keyRegistered || messageSigned}
                        className="btn-primary"
                      >
                        {isSigning ? 'Signing with REAL Dilithium...' : 'üî• Sign with REAL Dilithium'}
                      </button>
                      
                      {messageSigned && (
                        <div className="success-message">
                          <p>‚úÖ REAL Dilithium-5 signature created via Rust binary!</p>
                          <p className="hash-display">Sig: {signature.substring(0, 10)}...{signature.substring(signature.length - 10)}</p>
                        </div>
                      )}
                    </div>
                    
                    <div className="step">
                      <h3>Step 4: Send with REAL Dual Verification</h3>
                      <p>REAL RISC Zero zkVM proof + ECDSA in single transaction</p>
                      <div className="dual-info">
                        <p>üîê ECDSA: MetaMask signature (quantum-vulnerable)</p>
                        <p>üõ°Ô∏è Post-Quantum: REAL Dilithium + REAL RISC Zero zkVM</p>
                      </div>
                      <div className="input-group">
                        <input 
                          type="text" 
                          value={recipient} 
                          onChange={handleRecipientChange}
                          placeholder="Recipient address (0x...)"
                        />
                      </div>
                      <div className="input-group">
                        <input 
                          type="text" 
                          value={amount} 
                          onChange={handleAmountChange}
                          placeholder="Amount (ETH)"
                        />
                      </div>
                      <button 
                        onClick={sendTransaction} 
                        disabled={isSending || !messageSigned || !recipient || !amount || !signer}
                        className="btn-primary dual-verify-btn"
                      >
                        {isSending ? 'Sending with REAL zkVM Proof...' : 'üî• Send with REAL Dual Verification'}
                      </button>
                      
                      {txResult && txResult.success && (
                        <div className="success-message dual-success">
                          <p>üî• REAL dual verification transaction sent! üî•</p>
                          <p>üîê ECDSA: MetaMask signature verified</p>
                          <p>üõ°Ô∏è Post-Quantum: REAL Dilithium + REAL RISC Zero zkVM verified</p>
                          <p>TX: {txResult.txHash.substring(0, 10)}...{txResult.txHash.substring(txResult.txHash.length - 10)}</p>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {error && (
                    <div className="error-message">
                      <p>‚ùå {error}</p>
                    </div>
                  )}
                </div>
              </div>

              <style jsx="true">{`
                .app-container {
                  max-width: 800px;
                  margin: 0 auto;
                  padding: 20px;
                  font-family: Arial, sans-serif;
                }
                
                header {
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  margin-bottom: 30px;
                  text-align: center;
                }
                
                .connect-button {
                  background-color: #4CAF50;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 16px;
                  margin-top: 10px;
                }
                
                .account-info {
                  background-color: #f1f1f1;
                  padding: 10px 15px;
                  border-radius: 4px;
                  margin-top: 10px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 5px;
                }
                
                .network-badge {
                  background-color: #007bff;
                  color: white;
                  padding: 3px 8px;
                  border-radius: 10px;
                  font-size: 12px;
                }
                
                .contract-info {
                  background-color: #ff6b6b;
                  color: white;
                  padding: 15px;
                  border-radius: 4px;
                  margin-bottom: 20px;
                  font-size: 14px;
                  font-weight: bold;
                }
                
                .status-real {
                  color: white;
                  font-weight: bold;
                }
                
                .tab-content {
                  padding: 20px;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                }
                
                .workflow-steps {
                  display: flex;
                  flex-direction: column;
                  gap: 20px;
                }
                
                .step {
                  border: 2px solid #ff6b6b;
                  border-radius: 4px;
                  padding: 15px;
                  background-color: #fff5f5;
                }
                
                .dual-info {
                  background-color: #fff3cd;
                  padding: 10px;
                  border-radius: 4px;
                  margin: 10px 0;
                  font-size: 14px;
                  border: 1px solid #ffeaa7;
                }
                
                .input-group {
                  margin-bottom: 15px;
                }
                
                .input-group input {
                  width: 100%;
                  padding: 8px;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                  font-family: monospace;
                }
                
                .btn-primary {
                  background-color: #ff6b6b;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 4px;
                  cursor: pointer;
                  font-weight: bold;
                }
                
                .dual-verify-btn {
                  background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
                  font-size: 16px;
                  padding: 12px 24px;
                }
                
                button:disabled {
                  background-color: #ccc;
                  cursor: not-allowed;
                }
                
                .success-message {
                  margin-top: 15px;
                  padding: 10px;
                  background-color: #d4edda;
                  border: 1px solid #c3e6cb;
                  border-radius: 4px;
                  color: #155724;
                }
                
                .dual-success {
                  background: linear-gradient(135deg, #d4edda, #ffecb3);
                  border: 2px solid #ff6b6b;
                  font-weight: bold;
                }
                
                .error-message {
                  margin-top: 15px;
                  padding: 10px;
                  background-color: #f8d7da;
                  border: 1px solid #f5c6cb;
                  border-radius: 4px;
                  color: #721c24;
                }
                
                .hash-display {
                  font-family: monospace;
                  word-break: break-all;
                }
              `}</style>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>